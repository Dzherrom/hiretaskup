{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="container" style="padding:2rem 0;">
  <h1>Stripe Test Payment</h1>
  <p>Use Stripe test card 4242 4242 4242 4242 with any future date and any CVC.</p>
  <div style="margin: 1rem 0;">
    <label>Amount (USD cents):</label>
    <input id="amount" type="number" value="500" min="50" step="50" />
  </div>
  <button id="checkoutButton" class="btn btn-primary">Pay with Stripe</button>
  <div id="error" style="color:red; margin-top:1rem;"></div>
  <p style="margin-top:1rem;">After payment you'll be redirected here:
    <code>/payments/success/</code> or <code>/payments/cancel/</code>.</p>
  <p><a href="/payments/success/">Success page</a> | <a href="/payments/cancel/">Cancel page</a></p>
  
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const resp = await fetch("{% url 'stripe-config' %}");
  const { publicKey } = await resp.json();
  if (!publicKey) {
    document.getElementById('error').textContent = 'Missing STRIPE_PUBLISHABLE_KEY. Set your env vars.';
    return;
  }
  const stripe = Stripe(publicKey);

  const btn = document.getElementById('checkoutButton');
  btn.addEventListener('click', async () => {
    const amount = Number(document.getElementById('amount').value || 500);
    const res = await fetch("{% url 'stripe-create-checkout-session' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount, currency: 'usd', name: 'Test Product' })
    });
    if (!res.ok) {
      document.getElementById('error').textContent = 'Failed to create session.';
      return;
    }
    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
      if (error) document.getElementById('error').textContent = error.message;
    }
  });
});
</script>
{% endblock %}